import { callRtp, callQr, callPayout, readRes } from "./api.js";
import { uuidv4 } from "./helpers/uuid.js";
import { renderQr } from "./qr.js";

let mode = "RTP";

// tabs
let modeRtpBtn, modeQrBtn, modePayoutBtn, modeBulkBtn;

// inputs
let merchantIdEl, amountEl, orderIdEl, requestIdEl;
let rtpTypeEl, debitorTypeEl, debitorValueEl;
let qrTypeEl;
let creditorIbanEl;

let sendBtnEl;

// wrappers / sections
let amountWrapEl, rtpTypeWrapEl, qrTypeWrapEl;
let singleSectionEl, bulkSectionEl;

let merchantWrapEl, orderWrapEl, creditorWrapEl;

// left panels
let qrWrapEl, rtpRespWrapEl, bulkRespWrapEl;
let qrCanvasEl, qrPayloadEl;
let statusPillEl, responseBoxEl;

// blocks
let rtpOnlyEls = [];
let payoutOnlyEls = [];

// qr auto-on-enter flag
let qrAutoGeneratedThisVisit = false;

export function initUI() {
  modeRtpBtn = document.getElementById("modeRtp");
  modeQrBtn = document.getElementById("modeQr");
  modePayoutBtn = document.getElementById("modePayout");
  modeBulkBtn = document.getElementById("modeBulk");

  singleSectionEl = document.getElementById("singleSection");
  bulkSectionEl = document.getElementById("bulkSection");

  // left blocks
  qrWrapEl = document.getElementById("qrWrap");
  rtpRespWrapEl = document.getElementById("rtpRespWrap");
  bulkRespWrapEl = document.getElementById("bulkRespWrap");

  qrCanvasEl = document.getElementById("qrCanvas");
  qrPayloadEl = document.getElementById("qrPayload");

  statusPillEl = document.getElementById("statusPill");
  responseBoxEl = document.getElementById("responseBox");

  // inputs
  merchantIdEl = document.getElementById("merchantId");
  amountEl = document.getElementById("amount");
  orderIdEl = document.getElementById("orderId");
  requestIdEl = document.getElementById("requestId");

  rtpTypeEl = document.getElementById("rtpType");
  debitorTypeEl = document.getElementById("debitorType");
  debitorValueEl = document.getElementById("debitorValue");

  qrTypeEl = document.getElementById("qrType");

  creditorIbanEl = document.getElementById("creditorIban");

  // wrappers
  amountWrapEl = document.getElementById("amountWrap");
  rtpTypeWrapEl = document.getElementById("rtpTypeWrap");
  qrTypeWrapEl = document.getElementById("qrTypeWrap");

  merchantWrapEl = document.getElementById("merchantWrap");
  orderWrapEl = document.getElementById("orderWrap");
  creditorWrapEl = document.getElementById("creditorWrap");

  sendBtnEl = document.getElementById("sendBtn");

  rtpOnlyEls = Array.from(document.querySelectorAll(".rtpOnly"));
  payoutOnlyEls = Array.from(document.querySelectorAll(".payoutOnly"));

  // init
  requestIdEl.value = uuidv4();
  setMode("RTP");

  // tabs
  modeRtpBtn.onclick = () => setMode("RTP");
  modeQrBtn.onclick = () => setMode("QR");
  modePayoutBtn.onclick = () => setMode("PAYOUT");
  modeBulkBtn.onclick = () => setMode("BULK");

  // buttons
  document.getElementById("regenBtn").onclick = () => {
    requestIdEl.value = uuidv4();
  };
  document.getElementById("clearBtn").onclick = clearAll;
  sendBtnEl.onclick = send;

  // debitor label sync
  debitorTypeEl?.addEventListener("change", syncDebitorLabel);
  syncDebitorLabel();

  // QR type affects amount visibility
  qrTypeEl?.addEventListener("change", syncQrTypeUI);
  syncQrTypeUI();
}

function setMode(m) {
  mode = m;

  modeRtpBtn.classList.toggle("active", m === "RTP");
  modeQrBtn.classList.toggle("active", m === "QR");
  modePayoutBtn.classList.toggle("active", m === "PAYOUT");
  modeBulkBtn.classList.toggle("active", m === "BULK");

  // right panels
  singleSectionEl.classList.toggle("isHidden", m === "BULK");
  bulkSectionEl.classList.toggle("isHidden", m !== "BULK");
  bulkSectionEl.setAttribute("aria-hidden", m !== "BULK" ? "true" : "false");

  // left panels
  qrWrapEl.classList.toggle("isHidden", m !== "QR");
  rtpRespWrapEl.classList.toggle("isHidden", m === "BULK"); // show for RTP/QR/PAYOUT
  bulkRespWrapEl.classList.toggle("isHidden", m !== "BULK");
  bulkRespWrapEl.setAttribute("aria-hidden", m !== "BULK" ? "true" : "false");

  // show/hide blocks
  rtpOnlyEls.forEach((el) => el.classList.toggle("isHidden", m !== "RTP"));
  payoutOnlyEls.forEach((el) => el.classList.toggle("isHidden", m !== "PAYOUT"));

  // QR type dropdown only in QR
  qrTypeWrapEl.classList.toggle("isHidden", m !== "QR");

  // Merchant + Order not needed for payout
  merchantWrapEl.classList.toggle("isHidden", m === "PAYOUT");
  orderWrapEl.classList.toggle("isHidden", m === "PAYOUT");

  // amount rules
  if (m === "QR") {
    syncQrTypeUI();
  } else {
    amountWrapEl.classList.remove("isHidden");
  }

  // button label
  if (m === "QR") sendBtnEl.textContent = "Generate";
  else if (m === "PAYOUT") sendBtnEl.textContent = "Send Payout";
  else sendBtnEl.textContent = "Send";

  // entering QR: auto-generate once (if valid)
  if (m === "QR") {
    qrAutoGeneratedThisVisit = false;
    maybeAutoGenerateQrOnEnter();
  }

  // leaving QR: clear preview
  if (m !== "QR") {
    qrPayloadEl.value = "";
    qrCanvasEl.innerHTML = "";
    qrAutoGeneratedThisVisit = false;
  }

  if (m === "BULK") setStatus("—");
}

function syncQrTypeUI() {
  if (mode !== "QR") return;

  const qt = (qrTypeEl.value || "DYNAMIC").toUpperCase();
  if (qt === "STATIC") {
    amountWrapEl.classList.add("isHidden");
    amountEl.value = "";
  } else {
    amountWrapEl.classList.remove("isHidden");
  }
}

function setStatus(text, ok) {
  statusPillEl.textContent = text;
  statusPillEl.classList.remove("ok", "bad");
  if (ok === true) statusPillEl.classList.add("ok");
  if (ok === false) statusPillEl.classList.add("bad");
}

function syncDebitorLabel() {
  const label = document.getElementById("debitorLabel");
  if (!label || !debitorTypeEl) return;

  const t = debitorTypeEl.value;
  if (t === "IBAN") {
    label.textContent = "Debitor (IBAN)";
    debitorValueEl.placeholder = "PK..";
  } else if (t === "RAAST_ID") {
    label.textContent = "Debitor (RAAST ID)";
    debitorValueEl.placeholder = "Enter RAAST ID";
  } else {
    label.textContent = "Debitor (Vault Token)";
    debitorValueEl.placeholder = "vault_...";
  }
}

function clearAll() {
  merchantIdEl.value = "";
  amountEl.value = "";
  orderIdEl.value = "";
  requestIdEl.value = uuidv4();

  if (debitorTypeEl) debitorTypeEl.value = "IBAN";
  if (debitorValueEl) debitorValueEl.value = "";
  syncDebitorLabel();

  if (creditorIbanEl) creditorIbanEl.value = "";

  // Reset QR type to DYNAMIC
  if (qrTypeEl) qrTypeEl.value = "DYNAMIC";
  syncQrTypeUI();

  responseBoxEl.value = "";
  qrPayloadEl.value = "";
  qrCanvasEl.innerHTML = "";
  qrAutoGeneratedThisVisit = false;

  setStatus("—");
}

function getCommonFields() {
  const merchant = merchantIdEl?.value?.trim() || "";
  const amountNum = Number(amountEl.value);
  const order = orderIdEl?.value?.trim() || "";
  const reqId = requestIdEl.value.trim() || uuidv4();
  return { merchant, amountNum, order, reqId };
}

function canGenerateQrNow() {
  const { merchant, amountNum, order, reqId } = getCommonFields();
  const qt = (qrTypeEl.value || "DYNAMIC").toUpperCase();
  if (!merchant || !order || !reqId) return false;
  if (qt === "STATIC") return true;
  return Number.isFinite(amountNum) && amountNum > 0;
}

async function maybeAutoGenerateQrOnEnter() {
  if (qrAutoGeneratedThisVisit) return;

  if (!canGenerateQrNow()) {
    setStatus("Fill fields, then Generate", false);
    return;
  }

  qrAutoGeneratedThisVisit = true;
  await generateQr();
}

async function send() {
  if (mode === "BULK") return;

  responseBoxEl.value = "";
  setStatus(mode === "QR" ? "Generating…" : "Sending…");

  const { merchant, amountNum, order, reqId } = getCommonFields();
  requestIdEl.value = reqId;

  try {
    // PAYOUT
    if (mode === "PAYOUT") {
      if (!Number.isFinite(amountNum) || amountNum <= 0) return setStatus("Invalid amount", false);
      const creditor = creditorIbanEl?.value?.trim() || "";
      if (!creditor) return setStatus("Missing creditor_iban", false);

      const res = await callPayout({
        request_id: reqId,
        amount: String(amountEl.value).trim(),
        creditor_iban: creditor,
        type: "PAYOUT",
      });

      const { json, raw } = await readRes(res);
      responseBoxEl.value = json ? JSON.stringify(json, null, 2) : raw;
      setStatus(`PAYOUT (HTTP ${res.status})`, res.ok);
      return;
    }

    // QR
    if (mode === "QR") {
      await generateQr();
      return;
    }

    // RTP
    if (!merchant) return setStatus("Missing merchant id", false);
    if (!order) return setStatus("Missing order_id", false);
    if (!reqId) return setStatus("Missing request_id", false);

    if (!Number.isFinite(amountNum) || amountNum <= 0) return setStatus("Invalid amount", false);

    const debType = debitorTypeEl.value;
    const debVal = debitorValueEl.value.trim();
    if (!debVal) return setStatus("Missing debitor value", false);

    const res = await callRtp({
      aggregator_merchant_identifier: merchant,
      amount: amountNum,
      type: rtpTypeEl.value,
      order_id: order,
      request_id: reqId,
      debitor_type: debType,
      debitor_value: debVal,
    });

    const { json, raw } = await readRes(res);
    responseBoxEl.value = json ? JSON.stringify(json, null, 2) : raw;
    setStatus(`RTP (HTTP ${res.status})`, res.ok);
  } catch (e) {
    responseBoxEl.value = String(e);
    setStatus("Request failed", false);
  }
}

async function generateQr() {
  const { merchant, amountNum, order, reqId } = getCommonFields();
  const qt = (qrTypeEl.value || "DYNAMIC").toUpperCase();

  if (!merchant || !order || !reqId) {
    setStatus("Missing fields", false);
    return;
  }

  if (qt !== "STATIC") {
    if (!Number.isFinite(amountNum) || amountNum <= 0) {
      setStatus("Invalid amount", false);
      return;
    }
  }

  responseBoxEl.value = "";
  setStatus("Generating QR…");

  try {
    const payload = {
      aggregator_merchant_identifier: merchant,
      order_id: order,
      request_id: reqId,
      qr_type: qt,
    };
    if (qt === "DYNAMIC") payload.amount = amountNum;

    const res = await callQr(payload);
    const { json, raw } = await readRes(res);

    responseBoxEl.value = json ? JSON.stringify(json, null, 2) : raw;

    const code = json?.code ?? json?.data?.code ?? "";
    if (!code) {
      qrPayloadEl.value = "";
      qrCanvasEl.innerHTML = "";
      setStatus(`QR failed (HTTP ${res.status})`, false);
      return;
    }

    qrPayloadEl.value = code;
    renderQr(qrCanvasEl, code, 300);
    setStatus(`QR ready (HTTP ${res.status})`, true);
  } catch (e) {
    responseBoxEl.value = String(e);
    setStatus("QR request failed", false);
  }
}
